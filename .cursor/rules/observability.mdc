---
description: Kubernetes observability stack for monitoring, logging, and metrics collection
globs: k8s/observability/*, k8s/dozzle/*, k8s/grafana/*, k8s/loki/*, k8s/prometheus/*, k8s/promtail/*
alwaysApply: false
---

# Observability Stack Architecture

## **Components & Data Flow**
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   ALL PODS  │ => │  PROMTAIL   │ => │    LOKI     │ => │   GRAFANA   │
│             │    │ (Log Agent) │    │ (Log Store) │    │ (Dashboard) │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                              ^
      ┌─────────────┐    ┌─────────────┐                      │
      │    NODES    │ => │ PROMETHEUS  │ => ══════════════════┘
      │ (Metrics)   │    │ (TS Store)  │
      └─────────────┘    └─────────────┘
                            ^
                    ┌─────────────┐
                    │  EXPORTERS  │
                    │ (Collectors)│
                    └─────────────┘
```

## **Service Endpoints**
- **Dozzle**: http://home.server:30080/logs/ (real-time log viewer)
- **Grafana**: Internal dashboards for metrics & logs
- **Prometheus**: Metrics collection & alerting
- **Loki**: Log aggregation & storage

## **Log Collection (Promtail)**
- **Coverage**: Focused collection (~91 files total)
  - **Applications**: Default namespace (6 files) - core services
  - **Observability**: Monitoring stack (13 files) - metrics & logs
  - **Infrastructure**: Shared services (42 files) - databases
  - **Traffic**: Traefik ingress (5 files) - HTTP request logs
  - **DNS**: CoreDNS logs (25 files) - connectivity troubleshooting
  - **Excluded**: Other kube-system noise (~59 files eliminated)
- **Method**: Static configuration with job-specific wildcards
- **Processing**: CRI format parsing, metadata enrichment, job labeling
- **Destination**: Loki via HTTP push

## **Metrics Collection (Prometheus)**
- **Node Exporter**: System metrics (CPU, memory, disk, network)
- **Kube State Metrics**: Kubernetes object states and pod metrics
- **Scraping**: Automatic service discovery
- **Storage**: Time-series database

## **Resource Requirements**
- **Loki**: 1Gi memory limit (optimized for 66 focused log files + traffic)
- **Promtail**: DaemonSet with minimal resource usage
- **Prometheus**: Standard metrics collection requirements
- **Grafana**: Dashboard rendering and query processing

## **Key Features**
- ✅ **Focused Coverage**: ~91 essential log files (39% reduction from 150)
- ✅ **Traffic Monitoring**: HTTP request logs via Traefik ingress
- ✅ **DNS Troubleshooting**: CoreDNS logs for connectivity issues
- ✅ **Real-time Viewing**: Dozzle for live log streaming
- ✅ **Historical Analysis**: Grafana dashboards (logs, metrics, applications, traffic)
- ✅ **Traffic Analysis**: HTTP request patterns, error rates, endpoint usage
- ✅ **Alerting**: Prometheus rules for critical conditions
- ✅ **High Performance**: Optimized processing, efficient storage
- ✅ **Rich Metadata**: Job-based labeling (applications, observability, infrastructure, traffic, dns)

## **Common Queries**
```logql
# LogQL examples for Grafana - Job-based filtering
{job="applications"} |= "error"                # Errors in your applications
{job="observability"} |= "error"              # Monitoring stack errors
{job="infrastructure"} |= "error"             # Database/infrastructure errors
{job="traffic"} |= "HTTP"                      # All HTTP requests via Traefik
{job="traffic"} |~ "\"(GET|POST|PUT|DELETE)"   # HTTP method filtering
{job="traffic"} |~ "\"[4-5][0-9][0-9]"        # HTTP 4xx/5xx error responses
{job="dns"} |= "NXDOMAIN"                      # DNS resolution failures
{job="dns"} |= "query"                         # All DNS queries
{job="applications", container="ollama"} | json # Ollama structured logs
{job="infrastructure", container="postgres"}   # Database logs only
```

## **Enhancement Roadmap**
- **Implemented**: Job-based collection, traffic monitoring, DNS troubleshooting, alerting rules, traffic analysis dashboard
- **Next Priority**: Security monitoring, performance metrics, log-based alerting  
- **Advanced**: Log-based metrics, JSON parsing, automated remediation

## **Deployment Pattern**
- **DaemonSet**: Promtail runs on each node for log collection
- **Deployment**: Single instances for Loki, Grafana, Prometheus
- **Storage**: Persistent volumes for data retention
- **Networking**: ClusterIP services with Traefik ingress