apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-alerts
  namespace: observability
data:
  alerts.yml: |
    groups:
      - name: critical-alerts
        rules:
          # High memory usage
          - alert: HighMemoryUsage
            expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes > 0.85
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "High memory usage detected"
              description: "Memory usage is above 85% for 5 minutes"
              
          # Pod restart alerts  
          - alert: PodRestartingFrequently
            expr: rate(kube_pod_container_status_restarts_total[1h]) > 0.5
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.pod }} restarting frequently"
              description: "Pod has restarted more than 3 times in the last hour"
              
          # Application down
          - alert: ApplicationDown
            expr: up{job=~"applications|observability"} == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Application {{ $labels.instance }} is down"
              description: "Critical application has been down for more than 1 minute"
              
          # High error rate
          - alert: HighErrorRate
            expr: rate(promhttp_metric_handler_requests_total{code=~"4..|5.."}[5m]) > 0.1
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "High error rate detected"
              description: "Error rate is above 10% for 2 minutes"
