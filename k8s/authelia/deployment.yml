apiVersion: apps/v1
kind: Deployment
metadata:
  name: authelia
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: authelia
  template:
    metadata:
      labels:
        app: authelia
    spec:
      securityContext:
        fsGroup: 2000
      initContainers:
        - name: copy-config
          image: busybox
          command: ['sh', '-c', 'cp -v /config-src/configuration.yml /config/ && ls -la /config/']
          volumeMounts:
            - name: config-src
              mountPath: /config-src
            - name: config
              mountPath: /config
        - name: init-db
          image: busybox
          command:
            - sh
            - -c
            - |
              mkdir -p /data
              if [ ! -f /data/db.sqlite3 ]; then
                touch /data/db.sqlite3
                chown 2000:2000 /data/db.sqlite3
                chmod 644 /data/db.sqlite3
              fi
              mkdir -p /notifications
              if [ ! -f /notifications/notification.txt ]; then
                touch /notifications/notification.txt
                chown 2000:2000 /notifications/notification.txt
                chmod 644 /notifications/notification.txt
              fi
              echo "Database file permissions:"
              ls -la /data/db.sqlite3
              echo "Notification file permissions:"
              ls -la /notifications/notification.txt
          volumeMounts:
            - name: data
              mountPath: /data
            - name: notifications
              mountPath: /notifications
      containers:
        - name: authelia
          image: authelia/authelia:latest
          securityContext:
            runAsUser: 2000
            runAsGroup: 2000
          env:
            - name: AUTHELIA_SESSION_SECRET
              valueFrom:
                secretKeyRef:
                  name: authelia-secrets
                  key: AUTHELIA_SESSION_SECRET
            - name: AUTHELIA_STORAGE_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: authelia-secrets
                  key: AUTHELIA_STORAGE_ENCRYPTION_KEY
            - name: AUTHELIA_JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: authelia-secrets
                  key: AUTHELIA_JWT_SECRET
          ports:
            - containerPort: 9091
          volumeMounts:
            - name: config
              mountPath: /config
            - name: data
              mountPath: /config/db.sqlite3
              subPath: db.sqlite3
            - name: notifications
              mountPath: /config/notification.txt
              subPath: notification.txt
      volumes:
        - name: config-src
          configMap:
            name: authelia-config
        - name: config
          emptyDir: {}
        - name: data
          persistentVolumeClaim:
            claimName: authelia-data
        - name: notifications
          persistentVolumeClaim:
            claimName: authelia-notifications
